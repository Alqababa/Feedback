<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… - Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·</title>

    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Tajawal", sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
        }

        .logo-container {
            position: relative;
            margin-bottom: 15px;
        }

        .logo {
            width: 100px;
            height: 100px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(1deg); }
        }

        h2 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: right;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: "Tajawal", sans-serif;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            direction: ltr;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s;
            color: #ddd;
            margin: 0;
        }

        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffcc00;
        }

        .submit-button {
            background: linear-gradient(135deg, #ff6b00, #ff8c00);
            color: white;
            border: none;
            padding: 16px 20px;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            margin: 15px 0 5px;
            font-family: "Tajawal", sans-serif;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.4);
            width: 100%;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 0, 0.6);
        }

        .submit-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .rating-description {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
            text-align: center;
        }

        .star-value {
            color: #007bff;
            font-weight: bold;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .loading {
            display: none;
            color: #007bff;
            margin: 10px 0;
        }

        .points-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #0066cc;
            display: none;
        }

        @media (max-width: 480px) {
            body { padding: 15px; }
            .container { padding: 20px 15px; }
            .logo { width: 90px; height: 90px; }
            h2 { font-size: 1.2rem; }
            .star-rating label { font-size: 28px; }
            .submit-button { padding: 14px 18px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://github.com/Alqababa/Feedback/blob/main/LOGO.png?raw=true" alt="Ù„ÙˆØ¬Ùˆ" class="logo" />
        </div>

        <h2>ğŸ¯ Ù‚ÙŠÙ…Ù†Ø§ ÙˆØ§Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·</h2>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø· -->
        <div id="pointsInfo" class="points-info">
            <strong>Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="currentPoints">0</span></strong>
            <br>ØªØ¨Ù‚Ù‰ <span id="remainingPoints">50</span> Ù†Ù‚Ø·Ø© Ù„Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©!
        </div>

        <form id="feedbackForm">
            <div class="form-group">
                <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                <input
                    type="tel"
                    id="phone"
                    required
                    pattern="05[0-9]{8}"
                    title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…"
                    placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05)"
                />
            </div>

            <div class="form-group">
                <label>Ù…Ø§ Ù…Ø¯Ù‰ Ø³Ø¹Ø§Ø¯ØªÙƒ Ø¨Ø·Ø¹Ø§Ù…Ù†Ø§ØŸ</label>
                <div class="star-rating">
                    <input type="radio" id="star5" name="rating" value="5" />
                    <label for="star5" title="Ù…Ù…ØªØ§Ø²">â˜…</label>
                    <input type="radio" id="star4" name="rating" value="4" />
                    <label for="star4" title="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹">â˜…</label>
                    <input type="radio" id="star3" name="rating" value="3" />
                    <label for="star3" title="Ø¬ÙŠØ¯">â˜…</label>
                    <input type="radio" id="star2" name="rating" value="2" />
                    <label for="star2" title="Ù…Ù‚Ø¨ÙˆÙ„">â˜…</label>
                    <input type="radio" id="star1" name="rating" value="1" />
                    <label for="star1" title="Ø¶Ø¹ÙŠÙ">â˜…</label>
                </div>
                <div class="rating-description">
                    <span class="star-value" id="starValue">Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù…Ù† 1 Ø¥Ù„Ù‰ 5 Ù†Ø¬ÙˆÙ…</span>
                </div>
            </div>

            <div class="form-group">
                <label for="comments">Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªÙƒ:</label>
                <textarea
                    id="comments"
                    rows="3"
                    placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ Ø±Ø£ÙŠÙƒ Ù„Ù†Ø³Ø§Ø¹Ø¯Ùƒ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„..."
                ></textarea>
            </div>

            <div class="loading" id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>

            <button type="submit" class="submit-button" id="submitButton">
                Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (+5 Ù†Ù‚Ø§Ø·)
            </button>
        </form>
    </div>

    <script>
        // ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB2kh06x0kA-SNA-dU2fu0-66xHsbATBRY",
            authDomain: "feedback-445b9.firebaseapp.com",
            projectId: "feedback-445b9",
            storageBucket: "feedback-445b9.firebasestorage.app",
            messagingSenderId: "771007711501",
            appId: "1:771007711501:web:412efa0484ba4d3203c844",
        };

        // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ğŸ”¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const feedbackForm = document.getElementById("feedbackForm");
        const starValueElement = document.getElementById("starValue");
        const loadingElement = document.getElementById("loading");
        const submitButton = document.getElementById("submitButton");
        const pointsInfo = document.getElementById("pointsInfo");
        const currentPointsElement = document.getElementById("currentPoints");
        const remainingPointsElement = document.getElementById("remainingPoints");

        // ğŸ”¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        function validatePhoneNumber(phone) {
            const phoneRegex = /^05[0-9]{8}$/;
            return phoneRegex.test(phone);
        }

        // ğŸ”¹ Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¬Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø±Ù‚Ù…
        async function getTotalPointsForPhone(phone) {
            try {
                const userReviewsRef = db.collection("feedback").where("phone", "==", phone);
                const userReviewsSnapshot = await userReviewsRef.get();
                
                let totalPoints = 0;
                userReviewsSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalPoints += parseInt(data.points) || 0;
                });
                
                console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø±Ù‚Ù… ${phone}: ${totalPoints}`);
                return totalPoints;
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·:", error);
                return 0;
            }
        }

        // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø·
        async function updatePointsInfo(phone) {
            if (!phone || !validatePhoneNumber(phone)) {
                pointsInfo.style.display = 'none';
                return;
            }

            try {
                const totalPoints = await getTotalPointsForPhone(phone);
                currentPointsElement.textContent = totalPoints;
                
                const remainingPoints = Math.max(0, 50 - totalPoints);
                remainingPointsElement.textContent = remainingPoints;
                
                pointsInfo.style.display = 'block';
                
                // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·
                if (totalPoints >= 50) {
                    pointsInfo.style.background = '#d4edda';
                    pointsInfo.style.color = '#155724';
                } else if (totalPoints >= 25) {
                    pointsInfo.style.background = '#fff3cd';
                    pointsInfo.style.color = '#856404';
                } else {
                    pointsInfo.style.background = '#e7f3ff';
                    pointsInfo.style.color = '#0066cc';
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø·:", error);
            }
        }

        // ğŸ”¹ Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        function clearForm() {
            document.getElementById("phone").value = "";
            document.getElementById("comments").value = "";
            document.querySelectorAll('input[name="rating"]').forEach((input) => {
                input.checked = false;
            });
            document.querySelectorAll(".star-rating label").forEach((star) => {
                star.style.color = "#ddd";
            });
            pointsInfo.style.display = 'none';
            setTimeout(updateStarDisplay, 100);
        }

        // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¬ÙˆÙ…
        function updateStarDisplay() {
            if (!starValueElement) return;

            const checkedStar = document.querySelector('input[name="rating"]:checked');
            if (checkedStar) {
                const value = checkedStar.value;
                const descriptions = {
                    1: "â­ ØªÙ‚ÙŠÙŠÙ…: 1/5 - Ø¶Ø¹ÙŠÙ",
                    2: "â­â­ ØªÙ‚ÙŠÙŠÙ…: 2/5 - Ù…Ù‚Ø¨ÙˆÙ„",
                    3: "â­â­â­ ØªÙ‚ÙŠÙŠÙ…: 3/5 - Ø¬ÙŠØ¯",
                    4: "â­â­â­â­ ØªÙ‚ÙŠÙŠÙ…: 4/5 - Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹",
                    5: "â­â­â­â­â­ ØªÙ‚ÙŠÙŠÙ…: 5/5 - Ù…Ù…ØªØ§Ø²",
                };
                starValueElement.textContent = descriptions[value] || "ØªÙ‚ÙŠÙŠÙ…: " + value + "/5";
                starValueElement.style.color = "#28a745";
            } else {
                starValueElement.textContent = "Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù…Ù† 1 Ø¥Ù„Ù‰ 5 Ù†Ø¬ÙˆÙ…";
                starValueElement.style.color = "#007bff";
            }
        }

        // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ø¬ÙˆÙ…
        function initializeStarEvents() {
            document.querySelectorAll(".star-rating input").forEach((star) => {
                star.addEventListener("change", updateStarDisplay);

                star.addEventListener("mouseover", function () {
                    const stars = document.querySelectorAll(".star-rating label");
                    const currentIndex = Array.from(stars).indexOf(this.nextElementSibling);
                    stars.forEach((star, index) => {
                        if (index >= currentIndex) {
                            star.style.color = "#ffcc00";
                        }
                    });
                });

                star.addEventListener("mouseout", function () {
                    const checkedStar = document.querySelector('input[name="rating"]:checked');
                    const stars = document.querySelectorAll(".star-rating label");
                    if (checkedStar) {
                        const checkedIndex = Array.from(stars).indexOf(checkedStar.nextElementSibling);
                        stars.forEach((star, index) => {
                            star.style.color = index >= checkedIndex ? "#ffcc00" : "#ddd";
                        });
                    } else {
                        stars.forEach((star) => (star.style.color = "#ddd"));
                    }
                });
            });
        }

        // ğŸ”¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        async function handleFormSubmit(event) {
            event.preventDefault();

            const phone = document.getElementById("phone").value.trim();
            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            const comments = document.getElementById("comments").value.trim();

            if (!validatePhoneNumber(phone)) {
                alert("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù….");
                return;
            }

            if (!rating) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ø¬ÙˆÙ….");
                return;
            }

            try {
                loadingElement.style.display = "block";
                submitButton.disabled = true;
                submitButton.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

                /**/
                // ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹
                /*
                const today = new Date().toISOString().split('T')[0];
                const todayDocId = phone + "_" + today;
                const todayRef = db.collection("dailyChecks").doc(todayDocId);
                const todayDoc = await todayRef.get();

                if (todayDoc.exists) {
                    alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„!");
                    loadingElement.style.display = "none";
                    submitButton.disabled = false;
                    submitButton.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (+5 Ù†Ù‚Ø§Ø·)";
                    return;
                }
                */
                /**/

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const currentTotalPoints = await getTotalPointsForPhone(phone);
                const newTotalPoints = currentTotalPoints + 5;

                const uniqueId = phone + "_" + new Date().getTime();
                
                await db.collection("feedback").doc(uniqueId).set({
                    phone: phone,
                    rating: parseInt(rating),
                    comments: comments,
                    date: new Date().toISOString().split('T')[0],
                    points: 5,
                    timestamp: new Date().getTime(),
                    docId: uniqueId
                });

                /**/
                // ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ
                /*
                await todayRef.set({
                    phone: phone,
                    date: today,
                    rated: true,
                    timestamp: new Date().getTime()
                });
                */
                /**/

                clearForm();
                window.location.href = `thankyou.html?phone=${phone}&points=${newTotalPoints}`;
            } catch (error) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
                loadingElement.style.display = "none";
                submitButton.disabled = false;
                submitButton.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (+5 Ù†Ù‚Ø§Ø·)";
            }
        }

        // ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", function () {
            if (feedbackForm && starValueElement) {
                initializeStarEvents();
                updateStarDisplay();

                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø· Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                document.getElementById("phone").addEventListener("input", function() {
                    updatePointsInfo(this.value.trim());
                });

                feedbackForm.addEventListener("submit", handleFormSubmit);
            } else {
                console.error("Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            }
        });
    </script>
</body>
</html>
